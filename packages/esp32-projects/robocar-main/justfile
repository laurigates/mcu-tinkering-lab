# ESP-IDF Robocar Main Controller (Heltec WiFi LoRa 32)
# Run `just --list` to see available recipes

idf_path := env("IDF_PATH", home_directory() + "/repos/esp-idf")
port := env("PORT", "/dev/cu.usbserial-0001")

default:
    @just --list

[private]
check-idf:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ ! -d "{{idf_path}}" ]; then
        echo "Error: ESP-IDF not found at {{idf_path}}"
        echo "Install ESP-IDF or set IDF_PATH variable"
        exit 1
    fi

# Build the firmware
[group: "build"]
build: check-idf
    #!/usr/bin/env bash
    set -euo pipefail
    source {{idf_path}}/export.sh
    idf.py build

# Clean build files
[group: "build"]
clean: check-idf
    #!/usr/bin/env bash
    set -euo pipefail
    source {{idf_path}}/export.sh
    idf.py clean

# Full clean (removes build directory)
[group: "build"]
fullclean: check-idf
    #!/usr/bin/env bash
    set -euo pipefail
    source {{idf_path}}/export.sh
    idf.py fullclean

# Open configuration menu
[group: "build"]
menuconfig: check-idf
    #!/usr/bin/env bash
    set -euo pipefail
    source {{idf_path}}/export.sh
    idf.py menuconfig

# Flash firmware to ESP32
[group: "flash"]
flash: check-idf
    #!/usr/bin/env bash
    set -euo pipefail
    source {{idf_path}}/export.sh
    idf.py -p {{port}} flash

# Flash and immediately start monitoring
[group: "flash"]
flash-monitor: check-idf
    #!/usr/bin/env bash
    set -euo pipefail
    source {{idf_path}}/export.sh
    idf.py -p {{port}} flash monitor

# Monitor serial output (Ctrl+] to exit)
[group: "monitor"]
monitor: check-idf
    #!/usr/bin/env bash
    set -euo pipefail
    source {{idf_path}}/export.sh
    idf.py -p {{port}} monitor

# Show project information
[group: "info"]
info:
    @echo "ESP-IDF Robocar Controller"
    @echo "ESP-IDF Path: {{idf_path}}"
    @echo "Serial Port:  {{port}}"
    @echo "Hardware:     Heltec WiFi LoRa 32 V1"
