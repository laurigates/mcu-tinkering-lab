esphome:
  name: audiobook-player
  friendly_name: "Audiobook Player"
  on_boot:
    priority: -100  # Run after everything is initialized
    then:
      - script.execute: play_boot_sequence

esp32:
  board: wemosbat
  framework:
    type: esp-idf

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password
    on_begin:
      then:
        - deep_sleep.prevent: deep_sleep_control

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  on_connect:
    then:
      - script.execute: play_ready_sequence

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Audiobook-Player"
    password: !secret fallback_password

captive_portal:

# Deep sleep configuration for power management
deep_sleep:
  id: deep_sleep_control
  run_duration: 2min        # Stay awake for 2 minutes after wake
  wakeup_pin: GPIO27        # Tilt switch wakes device
  wakeup_pin_mode: INVERT_WAKEUP  # Wake when tilt switch closes (connects to GND)

# SPI bus configuration for RC522
spi:
  clk_pin: GPIO18   # SCK - ESP32 VSPI default
  miso_pin: GPIO19  # MISO - ESP32 VSPI default
  mosi_pin: GPIO23  # MOSI - ESP32 VSPI default

# RC522 RFID reader configuration
rc522_spi:
  cs_pin: GPIO17    # CS/SDA - Changed from GPIO5 (strapping pin)
  update_interval: 500ms

  # When a tag is detected, send it to Home Assistant
  on_tag:
    then:
      - text_sensor.template.publish:
          id: last_rfid_tag
          state: !lambda 'return x;'
      - homeassistant.tag_scanned: !lambda 'return x;'
      - homeassistant.event:
          event: esphome.audiobook_triggered
          data:
            device_id: audiobook-player
            tag_id: !lambda 'return x;'
      - logger.log:
          format: "Tag scanned: %s"
          args: ['x.c_str()']
      - script.execute: play_tag_success

  # When tag is removed
  on_tag_removed:
    then:
      - text_sensor.template.publish:
          id: last_rfid_tag
          state: ""
      - logger.log:
          format: "Tag removed: %s"
          args: ['x.c_str()']

# Text sensor to store the last scanned RFID tag
text_sensor:
  - platform: template
    name: "Last RFID Tag"
    id: last_rfid_tag
    icon: "mdi:card-account-details"

# Binary sensors for buttons
binary_sensor:
  # Green button - Play
  - platform: gpio
    pin:
      number: GPIO32  # Available GPIO pin
      mode:
        input: true
        pullup: true
      inverted: true
    name: "Play Button"
    id: play_button
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      then:
        - homeassistant.event:
            event: esphome.audiobook_control
            data:
              action: play

  # Red button - Pause
  - platform: gpio
    pin:
      number: GPIO33  # Available GPIO pin
      mode:
        input: true
        pullup: true
      inverted: true
    name: "Pause Button"
    id: pause_button
    filters:
      - delayed_on: 50ms
      - delayed_off: 50ms
    on_press:
      then:
        - homeassistant.event:
            event: esphome.audiobook_control
            data:
              action: pause

# Outputs for feedback indicators
output:
  # Status LED (built-in)
  - platform: gpio
    pin:
      number: GPIO16  # Built-in LED on WEMOS Battery ESP32
      inverted: true
    id: status_led_output

  # Piezo buzzer (PWM for tones)
  - platform: ledc
    pin: GPIO25
    id: buzzer_output

  # Vibration motor
  - platform: gpio
    pin: GPIO26
    id: vibration_output

# RTTTL buzzer for playing melodies
rtttl:
  output: buzzer_output
  id: buzzer_rtttl

# Scripts for feedback sequences
script:
  # Boot sequence - gentle ascending arpeggio
  - id: play_boot_sequence
    then:
      - light.turn_on:
          id: status_led
          effect: "Fast Blink"
      - rtttl.play: "boot:d=16,o=5,b=120:c,d,e,g"
      - delay: 1s

  # Ready sequence - device is connected and ready
  - id: play_ready_sequence
    then:
      - light.turn_on:
          id: status_led
          effect: "Slow Pulse"
      - rtttl.play: "ready:d=8,o=5,b=140:c,e,g"

  # Tag scanned successfully
  - id: play_tag_success
    then:
      # Play success chime
      - rtttl.play: "success:d=8,o=5,b=180:g,8c6"
      # Flash LED
      - light.turn_on:
          id: status_led
          brightness: 100%
          effect: "None"
      # Vibrate
      - output.turn_on: vibration_output
      - delay: 200ms
      - output.turn_off: vibration_output
      - delay: 100ms
      # Return to ready state
      - light.turn_on:
          id: status_led
          effect: "Slow Pulse"

  # Error feedback
  - id: play_error_sequence
    then:
      - rtttl.play: "error:d=8,o=5,b=140:e,c"
      - light.turn_on:
          id: status_led
          effect: "Fast Blink"
      # Triple vibration pulse
      - output.turn_on: vibration_output
      - delay: 100ms
      - output.turn_off: vibration_output
      - delay: 100ms
      - output.turn_on: vibration_output
      - delay: 100ms
      - output.turn_off: vibration_output
      - delay: 100ms
      - output.turn_on: vibration_output
      - delay: 100ms
      - output.turn_off: vibration_output

# Status LED as a light component with effects
light:
  - platform: binary
    name: "Status LED"
    id: status_led
    output: status_led_output
    effects:
      - strobe:
          name: "Fast Blink"
          colors:
            - state: true
              duration: 100ms
            - state: false
              duration: 100ms
      - strobe:
          name: "Slow Pulse"
          colors:
            - state: true
              duration: 500ms
            - state: false
              duration: 500ms
