# ESP32 Robot Car Simulation
# Run `just --list` to see available recipes

default:
    @just --list

##########
# setup
##########

# Verify all core dependencies are importable
[group: "setup"]
check-deps:
    #!/usr/bin/env bash
    set -euo pipefail
    uv run python -c "import numpy, scipy, matplotlib, websockets, serial, yaml, trimesh, pymunk, cv2" \
        && echo "All core dependencies available" \
        || { echo "Missing dependencies â€” run 'uv sync --extra dev'"; exit 1; }

# Validate robot config YAML and check deps
[group: "setup"]
setup: check-deps check-config
    @echo ""
    @echo "Setup complete! Try:"
    @echo "  just run          # Start simulation"
    @echo "  just test         # Run tests"
    @echo "  just info         # Show system info"

##########
# run
##########

# Run simulation in headless mode
[group: "run"]
run:
    PYTHONUNBUFFERED=1 uv run python src/main.py --headless

# Run simulation with GUI window
[group: "run"]
run-visual:
    PYTHONUNBUFFERED=1 uv run python src/main.py --visual

# Run simulation with browser interface (http://localhost:52000)
[group: "run"]
run-browser:
    @echo "Access visualization at: http://localhost:52000"
    PYTHONUNBUFFERED=1 uv run python src/main.py --browser

# Run headless simulation (explicit alias for run)
[group: "run"]
run-headless:
    PYTHONUNBUFFERED=1 uv run python src/main.py --headless

# Run demo movement pattern in headless mode
[group: "run"]
run-demo:
    PYTHONUNBUFFERED=1 uv run python src/main.py --demo-only --headless

# Run visual demo with GUI window
[group: "run"]
demo-visual:
    @echo "Watch the robot move in the 3D visualization window!"
    PYTHONUNBUFFERED=1 uv run python src/main.py --demo-only --visual

# Run demo with browser interface (http://localhost:52000)
[group: "run"]
demo-browser:
    @echo "Access visualization at: http://localhost:52000"
    PYTHONUNBUFFERED=1 uv run python src/main.py --demo-only --browser

# Run with ESP32 serial connection (headless)
[group: "run"]
run-serial serial_port:
    PYTHONUNBUFFERED=1 uv run python src/main.py --serial {{serial_port}} --headless

# Run with ESP32 serial connection and GUI visualization
[group: "run"]
serial-visual serial_port:
    @echo "Watch the robot move based on ESP32 commands!"
    PYTHONUNBUFFERED=1 uv run python src/main.py --serial {{serial_port}} --visual

##########
# test
##########

# Run all tests
[group: "test"]
test:
    uv run pytest tests/ -v

# Test robot model only
[group: "test"]
test-robot:
    uv run pytest tests/test_robot_model.py::TestDifferentialDriveRobot -v

# Test motor dynamics
[group: "test"]
test-motor:
    uv run pytest tests/test_robot_model.py::TestDCMotor -v

# Test simulation accuracy
[group: "test"]
test-accuracy:
    uv run pytest tests/test_robot_model.py::TestSimulationAccuracy -v

# Test communication bridge imports
[group: "test"]
test-comm:
    uv run python -c "import sys; sys.path.insert(0, 'src'); from communication_bridge import ESP32CommunicationBridge; print('Communication bridge imports OK')"

# Test visualization availability
[group: "test"]
test-viz:
    uv run python -c "import sys; sys.path.insert(0, 'src'); from swift_visualizer import SwiftSimulation, HAS_SWIFT; print(f'Swift available: {HAS_SWIFT}')"

# Quick smoke tests for core components
[group: "test"]
test-quick:
    #!/usr/bin/env bash
    set -euo pipefail
    uv run python -c "import sys; sys.path.insert(0, 'src'); from robot_model import DifferentialDriveRobot; print('Robot model OK')"
    uv run python -c "import sys; sys.path.insert(0, 'src'); from communication_bridge import ESP32CommunicationBridge; print('Communication bridge OK')"
    uv run python -c "import numpy, scipy, matplotlib, yaml; print('Core dependencies OK')"

##########
# dev
##########

# Run linter (ruff)
[group: "dev"]
lint:
    uv run ruff check src/ tests/

# Format code with ruff
[group: "dev"]
format:
    uv run ruff format src/ tests/

# Run type checking with mypy
[group: "dev"]
type-check:
    uv run mypy src/ --ignore-missing-imports

# Validate robot config YAML
[group: "dev"]
check-config:
    uv run python -c "import yaml; yaml.safe_load(open('config/robot_config.yaml')); print('Configuration valid')"

# Run performance benchmarks
[group: "dev"]
benchmark:
    uv run pytest tests/test_robot_model.py::TestSimulationAccuracy::test_simulation_stability -v -s

# Validate simulation against hardware
[group: "dev"]
validate serial_port:
    PYTHONUNBUFFERED=1 uv run python src/main.py --serial {{serial_port}} --validate

# Clean Python cache and temp files
[group: "dev"]
clean:
    #!/usr/bin/env bash
    set -euo pipefail
    find . -type f -name "*.pyc" -delete
    find . -type d -name "__pycache__" -delete
    find . -type d -name "*.egg-info" -exec rm -rf {} +
    find . -type f -name ".coverage" -delete
    find . -type d -name ".pytest_cache" -exec rm -rf {} +
    find . -type d -name ".mypy_cache" -exec rm -rf {} +

##########
# info
##########

# Show simulation information and available serial ports
[group: "info"]
info:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "ESP32 Robot Car Simulation"
    echo "Python version: $(uv run python --version)"
    echo "Working directory: $(pwd)"
    echo "Configuration: config/robot_config.yaml"
    echo ""
    echo "Available serial ports:"
    uv run python -c "import serial.tools.list_ports; [print(f'  {p.device}: {p.description}') for p in serial.tools.list_ports.comports()]" 2>/dev/null || echo "  pyserial not installed"

# Component status check
[group: "info"]
status:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "Simulation Status"
    printf "Robot model:          "
    uv run python -c "import sys; sys.path.insert(0, 'src'); from robot_model import DifferentialDriveRobot; print('OK')" 2>/dev/null || echo "Error"
    printf "Communication bridge: "
    uv run python -c "import sys; sys.path.insert(0, 'src'); from communication_bridge import ESP32CommunicationBridge; print('OK')" 2>/dev/null || echo "Error"
    printf "Genesis visualizer:   "
    uv run python -c "import sys; sys.path.insert(0, 'src'); from genesis_visualizer import HAS_GENESIS; print('Available' if HAS_GENESIS else 'Not available (matplotlib fallback active)')" 2>/dev/null || echo "Error"
    printf "Configuration:        "
    uv run python -c "import yaml; yaml.safe_load(open('config/robot_config.yaml')); print('Valid')" 2>/dev/null || echo "Invalid"
